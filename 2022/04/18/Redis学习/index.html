<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="Redis入门学习, Blog">
    <meta name="description" content="Redis 基础知识点">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    

    <title>Redis入门学习 | Blog</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery-3.6.0.min.js"></script>

<meta name="generator" content="Hexo 6.1.0"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">Blog</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">Blog</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/blinkfox/hexo-theme-matery" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/blinkfox/hexo-theme-matery" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/0.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">Redis入门学习</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Redis/">
                                <span class="chip bg-color">Redis</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/Redis/" class="post-category">
                                Redis
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2022-04-18
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2022-04-28
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    9k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    34 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <meta name="referrer" content="no-referrer" />

<h2 id="1-基础知识"><a href="#1-基础知识" class="headerlink" title="1.基础知识"></a>1.基础知识</h2><ul>
<li>Redis的<strong>端口号</strong>为6379</li>
<li>Redis总共拥有16个数据库，默认使用第0个</li>
<li>keys *命令 查看所有的key</li>
<li>flushdb 清除当前数据库</li>
<li>Redis是<strong>单线程</strong>的（速度快），基于内存操作（所以瓶颈为机器的内存和网络带宽）</li>
</ul>
<p>核心：redis将所有数据放在内存中，所以用单线程操作效率最高，而多线程牵扯到cpu的上下文切换（耗时）。<br>xshell连接redis,<strong>在 &#x2F;usr&#x2F;local&#x2F;bin 下</strong></p>
<pre class="line-numbers language-none"><code class="language-none">[root@VM-4-15-centos bin]## redis-server sjwconfig&#x2F;redis.conf
[root@VM-4-15-centos bin]## redis-cli -p 6379
127.0.0.1:6379&gt; 
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h2 id="2-五大数据类型"><a href="#2-五大数据类型" class="headerlink" title="2.五大数据类型"></a>2.五大数据类型</h2><h4 id="2-1-String"><a href="#2-1-String" class="headerlink" title="2.1 String"></a>2.1 String</h4><ul>
<li>append key value 在字符串后面追加value，返回数字，如果key不存在，就相当于set key</li>
<li>strlen key 返回key的值的字符串长度</li>
<li>incr key 给这个key的值+1。如果这个key不存在，则相当于set key 1.如果这个key的值不是一个数字，则返回 ERR value is not an integer or out of range。value不是一个数字或超出范围，范围是多大我也不知道，应该是integer的取值范围2147483648。</li>
<li>decr key 给这个key减一</li>
<li>incrby key 10 给这个key设置每次增加10，设置步长，指定增量</li>
<li>decrby key 5 给这个key设置每次自减5.</li>
<li>getrange key 0 3 获取key对应字符串的部分，相当于java的substring，如果是getranger key 0 -1 则表示获取key的所有&#x3D;GET KEY，而不是截取的部分</li>
<li>setrange key 2 xx 将字符串中下标为2的值替换为xx，例如set key1 abcde setrange key1 2 xx get key1返回abxxcd。相当于java的replace</li>
<li>setex key second value 表示设置后多少秒过期，seconds表示过期时间。ex就是expire</li>
<li>setnx key value 表示如果这个key不存在才设置，如果存在则不设置。nx就是 not exist</li>
<li>mset k1 v1 k2 v2 k3 v3 … 表示同时设置多个键值对</li>
<li>mget k1 k2 k3 同时获取多个</li>
<li>msetnx k1 v1 k2 v2 k3 v3 k4 v4.. 如果不存在则设置，如果key有一个存在的，则所有的都设置不成功。这是一个原子性的操作，<strong>redis的事务是不保证原子性操作的，但是msetnx是保证原子性操作的</strong>。</li>
<li>getset key value 先get 再set，当key不存在时，返回null 并设置这个key和value，当key存在时，返回key的值并用value覆盖之前的value</li>
</ul>
<p><strong>string类型的使用场景</strong>，value除了可以是字符串还可以是数字，因此可以用到以下场景：</p>
<ul>
<li><p>计数器：比如浏览量、粉丝数等等，当该对象被浏览了之后，可以使用incr articleid title；或者粉丝数 incr userid fans 或decr</p>
<h4 id="2-2-List"><a href="#2-2-List" class="headerlink" title="2.2 List"></a>2.2 List</h4><p>在redis中可以将List作为一个栈、队列、阻塞队列来实现。<br>所有的命令都是用L开头的,<strong>不区分大小写命令</strong></p>
</li>
<li><p>Lpush list  1 2 3 给list左边添加一个或多个元素</p>
</li>
<li><p>Rpush list  v1 v2 v3… 给list右边添加一个或多个元素</p>
</li>
<li><p>Lpop list 从列表的左边弹出一个元素</p>
</li>
<li><p>Rpop list 从列表的右边弹出一个元素，弹出后元素内容-1</p>
</li>
<li><p>Lindex list 0 获取list中下标为0的元素</p>
</li>
<li><p>Llen list 获取list长度</p>
</li>
<li><p>Lrem list count value表示移除list中count个value元素。</p>
</li>
<li><p>Ltrim list start stop 表示根据下标截取队列</p>
</li>
<li><p>rpoplpush list1 list2 将list1中最后一个元素移除，并将其放入list2中</p>
</li>
<li><p>lset 将列表中指定下标的值替换为另一个值，更新操作，如果列表不存在或下标不存在会报错</p>
</li>
<li><p>Linsert list befor&#x2F;after value newvalue 往list中的value的before或after插入一个newvalue处插入一个值。</p>
</li>
</ul>
<p><strong>Lpush Rpop 左边进右边出，这是一个队列；Lpush Lpop 左边进左边出，这是一个栈</strong></p>
<h4 id="2-3-Set"><a href="#2-3-Set" class="headerlink" title="2.3 Set"></a>2.3 Set</h4><p><strong>set不能重复(无序)</strong></p>
<ul>
<li>sadd set v1 v2 v3…. 往set集合中添加一个或多个元素，重复元素只能添加进一个</li>
<li>smembers set 获取所有元素</li>
<li>sismember set value 判断value是否存在</li>
<li>scard set 获取set中元素的个数</li>
<li>srem set value 将value移除set集合</li>
<li>srandmember set count 随机返回count个数的元素，count默认1</li>
<li>spop set count 从set中随机移除一个或count个元素</li>
<li>smove set newset member将set中的指定元素移动到newset中</li>
</ul>
<p>应用场景：<br>微博、b站 共同关注（交集）</p>
<ul>
<li><p>sdiff set1 set2 差集</p>
</li>
<li><p>sinter set1 set2交集 共同关注就可以这么实现</p>
</li>
<li><p>sunion set1 set2并集</p>
<h4 id="2-4-Hash"><a href="#2-4-Hash" class="headerlink" title="2.4 Hash"></a>2.4 Hash</h4></li>
<li><p>hset hash key value key1 value1 … 与string类似，命令以H开头，只不过值是k-v</p>
</li>
<li><p>hget hash key1 key2…</p>
</li>
<li><p>hmset hash key value key1 value1 … 多个操作</p>
</li>
<li><p>hmget hash key1 key2…</p>
</li>
<li><p>hgetall hash 获取所有的键值对</p>
</li>
<li><p>hdel hash key 删除指定的key的字段，对应的value也就没有了</p>
</li>
<li><p>hlen hash获取这个hash中有多少个键值对</p>
</li>
<li><p>hexists hsah key判断这个key是否存在</p>
</li>
<li><p>hkeys hash 获取所有key</p>
</li>
<li><p>hvals hash 获取所有value</p>
</li>
<li><p>hincrby hash key 1自增</p>
</li>
<li><p>hdecrby hash key 1自减</p>
</li>
<li><p>hsetnx hash key 如果不存在可以设置，如果存在，则不能设置<br>保存变更的数据，可以将一个用户变形为hashset hash user:id:name zhangsan，因此hash更适合存储对象，而string比较适合存储字符串</p>
<h4 id="2-5-Zset-有序集合"><a href="#2-5-Zset-有序集合" class="headerlink" title="2.5 Zset(有序集合)"></a>2.5 Zset(有序集合)</h4></li>
<li><p>zadd key 序号 value</p>
</li>
<li><p>zrange zset 0 -1</p>
</li>
<li><p>zrangebyscore key -inf +inf</p>
</li>
<li><p>zrem key member</p>
</li>
<li><p>zcard key</p>
</li>
<li><p>zcount  key start stop  获取指定区间的成员数量</p>
<h2 id=""><a href="#" class="headerlink" title=""></a></h2></li>
</ul>
<h2 id="3-三种特殊数据类型"><a href="#3-三种特殊数据类型" class="headerlink" title="3.三种特殊数据类型"></a>3.三种特殊数据类型</h2><h4 id="3-1-geospatial-地理位置"><a href="#3-1-geospatial-地理位置" class="headerlink" title="3.1 geospatial 地理位置"></a>3.1 geospatial 地理位置</h4><p>朋友的定位，附近的 人，打车距离，比如两地之间的距离等等<br>共六个命令</p>
<ul>
<li>geoadd key 维度 经度 名称 添加地理位置。南北极无法添加，一般会下载城市地理数据，使用java程序一次性导入，例子GEOADD Sicily 13.361389 38.115556 “Palermo” 15.087269 37.502669 “Catania”。经度和维度的范围超出会报错</li>
<li>geopos获取指定的城市的经度和维度</li>
<li>geodist<br>m 表示单位为米。<br>km 表示单位为千米。<br>mi 表示单位为英里。<br>ft 表示单位为英尺。<br>如果用户没有显式地指定单位参数， 那么 GEODIST 默认使用米作为单位。</li>
<li>georadius 如图，显示110 30 这个经纬度周围500km的城市<br><img src="https://cdn.nlark.com/yuque/0/2022/png/26758626/1650024795893-c1eb5b8a-cd59-4089-9a9d-ccad3d160c55.png##clientId=u77687043-8319-4&crop=0&crop=0&crop=1&crop=1&from=paste&id=u7d4449a7&margin=%5Bobject%20Object%5D&name=image.png&originHeight=79&originWidth=493&originalType=url&ratio=1&rotation=0&showTitle=false&size=31405&status=done&style=none&taskId=ub42a10a2-820b-4bc2-9bde-468be7c474e&title=" alt="image.png">附近的人的原理就是这个，当我们将所有用户的位置信息加入redis后，某个用户查看周围范围（可指定）多少人（可指定）</li>
<li>georadiusbymember找出位于指定范围内的元素，中心点是由给定的位置元素决定</li>
<li>geohash 了解一下 返回一个或多个位置元素的 Geohash 表示</li>
</ul>
<p><strong>geo的底层实现是基于zset，因此我们可以使用zset的命令来操作geo的元素</strong></p>
<h4 id="3-2-Hyperloglog-基数统计"><a href="#3-2-Hyperloglog-基数统计" class="headerlink" title="3.2 Hyperloglog 基数统计"></a>3.2 Hyperloglog 基数统计</h4><p>简介：<br>    Redis2.5.9版本更新了Hyperloglog数据结构<br>    应用场景：<strong>统计网站访问量</strong>，同一个人多次访问也只计做一次<br>传统的做法：使用set保存用户id，计算set的size，<strong>这个方法的缺点就是耗费内存</strong>，并且我们的主要目的是计算访问量，而不是保存id<br>使用Hyperloglog：<strong>内存占用小</strong>，2^64的数据仅占用12KB；错误率0.81%很低，基本上可以忽略不计</p>
<pre><code> 命令如下图：
</code></pre>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/26758626/1650026278568-6fe6dc46-2cc8-4c11-a48b-70ec3eff47ad.png##clientId=u77687043-8319-4&crop=0&crop=0&crop=1&crop=1&from=paste&id=u91010860&margin=%5Bobject%20Object%5D&name=image.png&originHeight=215&originWidth=593&originalType=url&ratio=1&rotation=0&showTitle=false&size=103555&status=done&style=none&taskId=u437f4dfb-33ae-44f5-87d4-429a395fba0&title=" alt="image.png"></p>
<h4 id="3-3-Bitmaps"><a href="#3-3-Bitmaps" class="headerlink" title="3.3 Bitmaps"></a>3.3 Bitmaps</h4><p>######## 使用场景：<br>统计用户信息，活跃、不活跃，登录、未登录，打卡，两种状态的都可以使用BitMap<br>######## 简介<br>Bitmap 位图，使用二进制来进行记录，只有0和1两个状态的都可以这么做</p>
<h2 id="4-redis事务操作"><a href="#4-redis事务操作" class="headerlink" title="4.redis事务操作"></a>4.redis事务操作</h2><p>Redis的事物中<strong>不保证原子性</strong>，但是Redis的<strong>单条命令是保证原子性</strong>的</p>
<hr>
<p>Redis事物的本质：<br>Redis会将一组命令保存在一个队列中，然后顺序执行，在事物中命令都会被序列化，并且是一次性全部执行完毕，不允许被打断。<br>redis的事物：</p>
<ul>
<li>开启事物：multi</li>
<li>命令入队：</li>
<li>执行事物：execu</li>
</ul>
<p> -放弃事物：discard<br><img src="https://cdn.nlark.com/yuque/0/2022/png/26758626/1650111442840-7d09e438-4e16-478b-b4e5-3c6c4262c705.png##clientId=u22d88724-ae18-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=398&id=u8d20da64&margin=%5Bobject%20Object%5D&name=image.png&originHeight=422&originWidth=401&originalType=binary&ratio=1&rotation=0&showTitle=false&size=8979&status=done&style=none&taskId=u3b238bcf-1dc0-4495-9575-2b1e07d6cfa&title=&width=378" alt="image.png"><br>异常：</p>
<ul>
<li>编译时异常：命令错误，在程序启动时就会报错，所有命令都不执行</li>
<li>运行时异常：抛出异常，其他命令执行</li>
</ul>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/26758626/1650111749757-56cdd771-3d54-4854-aeec-93bcd768acb2.png##clientId=u22d88724-ae18-4&crop=0&crop=0&crop=1&crop=1&from=paste&id=u490edf84&margin=%5Bobject%20Object%5D&name=image.png&originHeight=315&originWidth=569&originalType=url&ratio=1&rotation=0&showTitle=false&size=109673&status=done&style=none&taskId=uf7087ec5-a5e1-4543-a963-438953bcf8b&title=" alt="image.png"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/26758626/1650111783904-f47b0a1f-e0a0-47b7-b416-9788f101054c.png##clientId=u22d88724-ae18-4&crop=0&crop=0&crop=1&crop=1&from=paste&id=ub2e275f6&margin=%5Bobject%20Object%5D&name=image.png&originHeight=380&originWidth=709&originalType=url&ratio=1&rotation=0&showTitle=false&size=102322&status=done&style=none&taskId=uc4931ef8-8bd5-4f69-bdcd-12dfc6fcc3a&title=" alt="image.png"></p>
<h2 id="5-Redis锁："><a href="#5-Redis锁：" class="headerlink" title="5. Redis锁："></a>5. Redis锁：</h2><p>锁：</p>
<ul>
<li>悲观锁：认为任何时候都有可能出问题，因此在任何时候都要加锁</li>
<li>乐观锁：认为 一般不会出问题，所以不上锁。只有在特定的时候才上</li>
<li>使用watch实现乐观锁<br>举例：如下图，当我们有一个存款为100的时候，开启监视watch命令，然后开启事物，执行消费二十，然后给支出项增加二十，或者余额减去二十，然后提交事物，执行命令，这个时候是正常执行的没有问题。</li>
</ul>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/26758626/1650112193172-e538c453-dfdc-4fdb-9d18-f436a552af5b.png##clientId=u22d88724-ae18-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=320&id=uec6afa98&margin=%5Bobject%20Object%5D&name=image.png&originHeight=320&originWidth=635&originalType=binary&ratio=1&rotation=0&showTitle=false&size=11041&status=done&style=none&taskId=ue8921f2d-27f9-4174-92b8-9e2120fb097&title=&width=635" alt="image.png"><br>当出现如下情况的时候，首先监视money，这个时候它的值是100，然后开启事物，消费10块钱，支出项增加10，然后在exec命令执行之前，另一个线程中修改了money的值，这个时候exec执行的时候发现money的值已经改变了，就会返回一个null，表示事物执行失败	<br>    <img src="https://cdn.nlark.com/yuque/0/2022/png/26758626/1650112230147-a24271ab-34cc-402e-a256-d604e631ec59.png##clientId=u22d88724-ae18-4&crop=0&crop=0&crop=1&crop=1&from=paste&id=u9018c233&margin=%5Bobject%20Object%5D&name=image.png&originHeight=187&originWidth=578&originalType=url&ratio=1&rotation=0&showTitle=false&size=56825&status=done&style=none&taskId=uf300b9b3-40cc-454a-9d4f-a7955371c76&title=" alt="image.png"><br>那么如何解决这个问题呢？首先使用UNwatch命令解锁，将刚才出异常的锁释放掉，然后重新给 money加锁，重新开启事物，加入命令到队列，再exec，这个时候获取到的就是最新的money。<img src="https://cdn.nlark.com/yuque/0/2022/png/26758626/1650112230178-f7bdc262-f33b-465c-b9d7-d41745d7b80c.png##clientId=u22d88724-ae18-4&crop=0&crop=0&crop=1&crop=1&from=paste&id=uf51724d8&margin=%5Bobject%20Object%5D&name=image.png&originHeight=211&originWidth=565&originalType=url&ratio=1&rotation=0&showTitle=false&size=101817&status=done&style=none&taskId=uc41fb9ce-938a-4fb3-995e-16bb7b6cd8b&title=" alt="image.png"></p>
<h2 id="6-Jedis"><a href="#6-Jedis" class="headerlink" title="6. Jedis"></a>6. Jedis</h2><p>什么是jedis？<br>    jedis是Redis官方推荐的java连接开发工具，使用java操作redis中间件，在springboot中使用redisTemplate操作，但是还是要对jedis十分了解才行。</p>
<h4 id="6-1导入maven依赖"><a href="#6-1导入maven依赖" class="headerlink" title="6.1导入maven依赖"></a>6.1导入maven依赖</h4><pre class="line-numbers language-none"><code class="language-none">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;
&lt;project xmlns&#x3D;&quot;http:&#x2F;&#x2F;maven.apache.org&#x2F;POM&#x2F;4.0.0&quot;
xmlns:xsi&#x3D;&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;2001&#x2F;XMLSchema-instance&quot;
xsi:schemaLocation&#x3D;&quot;http:&#x2F;&#x2F;maven.apache.org&#x2F;POM&#x2F;4.0.0 http:&#x2F;&#x2F;maven.apache.org&#x2F;xsd&#x2F;maven-4.0.0.xsd&quot;&gt;
&lt;modelVersion&gt;4.0.0&lt;&#x2F;modelVersion&gt;

&lt;groupId&gt;org.example&lt;&#x2F;groupId&gt;
&lt;artifactId&gt;RedisDemo&lt;&#x2F;artifactId&gt;
&lt;version&gt;1.0-SNAPSHOT&lt;&#x2F;version&gt;
&lt;dependencies&gt;
&lt;dependency&gt;
&lt;groupId&gt;redis.clients&lt;&#x2F;groupId&gt;
&lt;artifactId&gt;jedis&lt;&#x2F;artifactId&gt;
&lt;version&gt;2.9.0&lt;&#x2F;version&gt;
&lt;&#x2F;dependency&gt;
&lt;dependency&gt;
&lt;groupId&gt;com.alibaba&lt;&#x2F;groupId&gt;
&lt;artifactId&gt;fastjson&lt;&#x2F;artifactId&gt;
&lt;version&gt;1.2.74&lt;&#x2F;version&gt;
&lt;&#x2F;dependency&gt;
&lt;&#x2F;dependencies&gt;
&lt;properties&gt;
&lt;maven.compiler.source&gt;11&lt;&#x2F;maven.compiler.source&gt;
&lt;maven.compiler.target&gt;11&lt;&#x2F;maven.compiler.target&gt;
&lt;&#x2F;properties&gt;

&lt;&#x2F;project&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="6-2-编码测试"><a href="#6-2-编码测试" class="headerlink" title="6.2 编码测试"></a>6.2 编码测试</h4><ul>
<li>连接数据库</li>
<li>操作命令</li>
<li>断开连接</li>
</ul>
<p>测试连接</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestPing</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//new Jedis 对象</span>
        <span class="token class-name">Jedis</span> jedis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Jedis</span><span class="token punctuation">(</span><span class="token string">"127.0.0.1"</span><span class="token punctuation">,</span><span class="token number">6379</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//jedis 的所有命令就是之前学习的命令</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>jedis<span class="token punctuation">.</span><span class="token function">ping</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="6-3-事务"><a href="#6-3-事务" class="headerlink" title="6.3 事务"></a>6.3 事务</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>sjw</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span><span class="token class-name">JSONObject</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">netscape<span class="token punctuation">.</span>javascript<span class="token punctuation">.</span></span><span class="token class-name">JSObject</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">redis<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>jedis<span class="token punctuation">.</span></span><span class="token class-name">Jedis</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">redis<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>jedis<span class="token punctuation">.</span></span><span class="token class-name">Transaction</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestTX</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Jedis</span> jedis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Jedis</span><span class="token punctuation">(</span><span class="token string">"127.0.0.1"</span><span class="token punctuation">,</span><span class="token number">6379</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">JSONObject</span> jsonObject <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JSONObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        jsonObject<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">,</span><span class="token string">"world"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        jsonObject<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span><span class="token string">"sjw"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        jedis<span class="token punctuation">.</span><span class="token function">flushDB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//开启事务</span>
        <span class="token class-name">Transaction</span> multi <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">multi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> result <span class="token operator">=</span> jsonObject<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token keyword">try</span><span class="token punctuation">&#123;</span>
            multi<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"user1"</span><span class="token punctuation">,</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
            multi<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"user2"</span><span class="token punctuation">,</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">;</span>   <span class="token comment">//代码抛出异常，执行失败</span>
            multi<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">//放弃事务</span>
            multi<span class="token punctuation">.</span><span class="token function">discard</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>jedis<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"user1"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            jedis<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="7-SpringBoot-集成-Redis"><a href="#7-SpringBoot-集成-Redis" class="headerlink" title="7. SpringBoot 集成 Redis"></a>7. SpringBoot 集成 Redis</h2><p>在springboot2.x之后，原来使用的jedis被替换为lettuce，为什么替换呢？<br>redis：采用直连的方式，多线程操作不安全，如果想要避免不安全，就要使用<strong>jedis pool连接池</strong>，类似<strong>BIO</strong>模型 ，是阻塞的。<br>lettuce：采用netty，实例可以在多个线程中共享，不存在线程不安全情况，更像<strong>NIO</strong>模型</p>
<p><strong>步骤：</strong></p>
<ul>
<li>导入依赖<br>在maven仓库或者spring官网都可以找到整个redis的依赖，加入启动器spring-boot-starter-data-redis，这个启动器底层是使用的spring-data-redis来连接redis的，springData也是spring的一个大型项目，包括jpa、jdbc、MongoDB、redis都是使用springdata进行连接。</li>
<li>配置连接<br>我们知道在springboot中有自动配置类和对应的properties类，这两个类帮助springBoot快速构建组件，这里我们说一下springBoot整合Redis的源码分析</li>
</ul>
<p>操作</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">class</span> <span class="token class-name">RedisSpringbootApplicationTests</span> <span class="token punctuation">&#123;</span>
    
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RedisTemplate</span> redisTemplate<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">void</span> <span class="token function">contextLoads</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//springboot 中opsForxxx即表示操作某个类型，如下：</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//操作string类型</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">opsForList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//操作List类型</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//操作map类型</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">opsForSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//操作set类型</span>
		
        <span class="token comment">//还有一些常用的操作，可以直接用redisTemplate进行</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">multi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//开启事务</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//执行事务</span>
<span class="token comment">//        redisTemplate.watch();//开启乐观锁</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">discard</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//关闭事务</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="8-redis配置详解"><a href="#8-redis配置详解" class="headerlink" title="8. redis配置详解"></a>8. redis配置详解</h2><p>redis的配置文件redis.conf，这个文件中使用###################################### 模块名############################ 这种方式将各个配置项分割开来，具体如下：</p>
<ul>
<li>单位配置：不知道这玩意是干啥的，一般不动。配置大小写不敏感</li>
<li>INCLUDES，包含，意思就是可以把其他配置文件包含进来组成一个配置文件，这在你有标准配置模板但是每个redis服务器又需要个性设置的时候很有用。并且include 配置最好放在配置文件的最后一行？<ul>
<li><h4 id="include-path-to-local-conf"><a href="#include-path-to-local-conf" class="headerlink" title="include .\path\to\local.conf"></a>include .\path\to\local.conf</h4></li>
<li><h4 id="include-c-path-to-other-conf"><a href="#include-c-path-to-other-conf" class="headerlink" title="include c:\path\to\other.conf"></a>include c:\path\to\other.conf</h4></li>
</ul>
</li>
<li>NETWORK 网络配置<ul>
<li>bind 127.0.0.1 绑定的ip</li>
<li>protected-mode yes 是否保护模式</li>
<li>port 6379 端口设置</li>
<li>timeout 0</li>
</ul>
</li>
<li>GENERAL 通用<ul>
<li>loglevel notice 日志级别<ul>
<li>debug (a lot of information, useful for development&#x2F;testing) 开发或测试时用</li>
<li>verbose (many rarely useful info, but not a mess like the debug level) 一些常用的信息</li>
<li>notice (moderately verbose, what you want in production probably) 生产模式使用</li>
<li>warning (only very important &#x2F; critical messages are logged) 只打印一些重要的 信息</li>
</ul>
</li>
<li>daemonize no 是否设置为守护进程，Windows中不支持该配置。默认yes</li>
<li>supervised no</li>
<li>pidfile &#x2F;var&#x2F;run&#x2F;redis.pid 如果以守护进程的方式运行，就需要指定这个pid文件，不知道有什么用</li>
<li>logfile “” 日志文件保存路径</li>
<li>databases 16 默认一共16个数据库</li>
<li>always-show-logo yes 启动时是否显示logo</li>
</ul>
</li>
<li>SNAPSHOTTING 快照，快照分rdb和aof<ul>
<li>save “” 持久化操作的策略<ul>
<li>save 900 1 如果900秒内有一次key进行了更新，则持久化一次</li>
<li>save 300 10 如果300秒内有10 key进行了更新，则持久化一次</li>
<li>save 60 10000 如果60秒 内有至少10000个key进行了更新，则持久化一次。一般情况我们不会使用这几种方式，一般都是</li>
</ul>
</li>
<li>stop-writes-on-bgsave-error yes 如果持久化过程出现错误，是否还要继续</li>
<li>rdbcompression yes 是否压缩rdb文件，需要消耗一些CPU资源</li>
<li>rdbchecksum yes 保存rdb文件的时候，进行错误的检查校验</li>
<li>dir .&#x2F; rdb文件保存的目录，默认当前目录下</li>
<li>dbfilename dump.rdb rdb文件的名字，默认dump</li>
</ul>
</li>
<li>REPLICATION 主从复制</li>
<li>SECURITY 安全 <strong>默认没有密码</strong> vm_redis:0&gt;config get requirepass  &#x2F;&#x2F;获取密码   1)  “requirepass”  2)  “” vm_redis:0&gt;config set requirepass 123456  &#x2F;&#x2F;设置密码 “OK” vm_redis:0&gt;config get requirepass   1)  “requirepass”  2)  “123456” vm_redis:0&gt;ping “PONG” vm_redis:0&gt;auth 123456  &#x2F;&#x2F;使用密码登录 “OK” 123456789101112<ul>
<li>requirepass foobared 设置密码，也可以使用如下命令</li>
</ul>
</li>
<li>CLIENTS 客户端配置<ul>
<li>maxclients 10000 最大允许一万个客户端连接</li>
<li>**maxmemory **配置redis的最大内存容量</li>
<li>maxmemory-policy noeviction 内存达到上限后的回收策略从已经设置了过期时间的key中去选择<ul>
<li>noeviction： 默认的策略，即当内存使用达到阈值的时候，所有引起申请内存的命令都会报错；</li>
<li><strong>allkeys-lru</strong>：从数据集（server.db[i].dict）中挑选最近最少使用的数据淘汰 。<br>适用场景： 如果我们的应用对缓存的访问都是相对热点数据，就可以选择这个策略；</li>
<li>allkeys-random：随机移除某个key。<br>适合的场景：如果我们的应用对于缓存key的访问概率相等，则可以使用这个策略。</li>
<li>volatile-random：从已设置过期时间的数据集（server.db[i].expires）中任意选择数据淘汰。</li>
<li>volatile-lru：从已设置过期时间的数据集（server.db[i].expires）中挑选最近最少使用的数据淘汰。</li>
<li>volatile-ttl：从已设置过期时间的数据集（server.db[i].expires）中挑选将要过期的数据淘汰；适合场景：这种策略使我们可以向Redis提示哪些key更适合被淘汰，可以自己控制 。</li>
</ul>
</li>
</ul>
</li>
<li>APPEND ONLY 模式 aof配置（了解，大部分情况下rdb已经足够使用，aof是对rdb的一个补充，并且性能不高，因此使用少）<ul>
<li>appendonly no** 默认不开启aof模式**，如果我们要启用aof，一般情况下只需要将该项配置改为yes即可</li>
<li>appendfilename “appendonly.aof” aof持久化文件的名字</li>
<li>appendfsync<ul>
<li>appendfsync always 每次修改都会同步，消耗性能</li>
<li>appendfsync everysec 每秒执行一次同步sync，可能会丢失这一秒的数据</li>
<li>appendfsync no 不执行同步，速度快</li>
</ul>
</li>
<li>no-appendfsync-on-rewrite no 保持默认即可</li>
<li>xxx-rewrite-xxx 重写配置（了解，一般不做修改）<ul>
<li>例如64M，就是说aof会一直将写操作命令追加进aof文件中，如果文件大小超过了这个64m，就会生成一个新的 文件<h2 id="9-Redis持久化"><a href="#9-Redis持久化" class="headerlink" title="9. Redis持久化"></a>9. Redis持久化</h2><h4 id="9-1-RDB"><a href="#9-1-RDB" class="headerlink" title="9.1 RDB"></a>9.1 RDB</h4>redis 是内存数据库，断电及失，因此需要持久化，默认使用RDB，一般情况下我们无需修改RDB配置，即可使用。<br>Redis会单独创建一个fork子进程来进行持久化，子进程中循环所有的数据，将数据写入到二进制文件中，会先将数据 写入到一个临时文件中，待持久化过程都结束了，在用这个临时文件替换上次持久化好了的文件。整个过程中，主进程是不进行任何IO操作的，确保极高的性能，如果需要进行大规模数据的回复，且对数据恢复的完整性不是非常敏感，那RDB方式要比AOF方式更加高效。<strong>RDB的缺点就是最后一次持久化后的数据可能丢失。</strong></li>
</ul>
</li>
</ul>
</li>
</ul>
<p><strong>RDB保存的文件就是dump.rdb</strong><br><strong>当我们修改了配置文件后，直接使用save命令就可以保存修改</strong><br><strong>1.触发机制</strong><br>(1)save的规则满足的情况下，会自动触发rdb规则<br>(2)执行 flushall 命令，也会触发我们的rdb规则！<br>(3)退出redis，也会产生 rdb 文件！<br>备份就自动生成一个 dump.rdb</p>
<p><strong>2.如何恢复rdb文件？</strong><br>(1)只需要将rdb文件放在我们redis启动目录就可以，redis启动的时候会自动检查dump.rdb 恢复其中的数据！<br>(2)查看需要存在的位置<br>127.0.0.1:6379&gt; config get dir </p>
<ol>
<li>“dir” </li>
<li>“&#x2F;usr&#x2F;local&#x2F;bin” ## 如果在这个目录下存在 dump.rdb 文件，启动就会自动恢复其中的数据</li>
</ol>
<p>几乎Redis的默认配置就够用了，但是我们还是需要去学习！<br><strong>RDB优点：</strong><br>1、适合大规模的数据恢复！<br>2、对数据的完整性要不高！</p>
<p><strong>RDB缺点：</strong><br>1、需要一定的时间间隔进程操作！如果redis意外宕机了，这个最后一次修改数据就没有的了！<br>2、fork进程的时候，会占用一定的内容空间<br><a target="_blank" rel="noopener" href="https://blog.51cto.com/zhangzhixi/3175577">
</a></p>
<h4 id="9-2-AOF（Append-Only-File）"><a href="#9-2-AOF（Append-Only-File）" class="headerlink" title="9.2 AOF（Append Only File）"></a>9.2 AOF（Append Only File）</h4><p>将我们的所有命令都记录下来，history，恢复的时候就把这个文件全部在执行一遍！</p>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/26758626/1650210740913-b53e2d50-e1aa-4042-ac7e-bb8d009f9375.png##clientId=u8a2ba187-a65d-4&crop=0&crop=0&crop=1&crop=1&from=paste&id=u0084cf48&margin=%5Bobject%20Object%5D&originHeight=776&originWidth=999&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=uc6033a2a-750b-4931-85fa-77817e76e14&title="></p>
<p>以日志的形式来记录每个写操作，将Redis执行过的所有指令记录下来（读操作不记录），只许追加文件但不可以改写文件，redis启动之初会读取该文件重新构建数据，换言之，redis重启的话就根据日志文件的内容将写指令从前到后执行一次以完成数据的恢复工作<br>Aof保存的是 appendonly.aof 文件</p>
<hr>
<p>append<br><img src="https://cdn.nlark.com/yuque/0/2022/png/26758626/1650210770377-366e2ea1-bb26-4d0b-9ead-faffedf82f40.png##clientId=u8a2ba187-a65d-4&crop=0&crop=0&crop=1&crop=1&from=paste&id=u44cf95c3&margin=%5Bobject%20Object%5D&originHeight=572&originWidth=1113&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u95fea192-c76e-4d7c-a876-e8a12c29965&title="><br>默认是不开启的，我们需要手动进行配置！我们只需要将 appendonly 改为yes就开启了 aof！<br>重启，redis 就可以生效了！<br>如果<strong>这个 aof 文件有错误，这时候 redis 是启动不起来的</strong>，我们需要修复这个aof文件<br>redis 给我们提供了一个工具 redis-check-aof –fix<br><img src="https://cdn.nlark.com/yuque/0/2022/png/26758626/1650210795417-be20bd78-178a-4b36-838f-1031a4878220.png##clientId=u8a2ba187-a65d-4&crop=0&crop=0&crop=1&crop=1&from=paste&id=u07f4fc2f&margin=%5Bobject%20Object%5D&originHeight=197&originWidth=1194&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u9fc3803b-8528-4d8d-ab83-931279ec6c0&title="><br> 如果文件正常，重启就可以直接恢复了！<br><img src="https://cdn.nlark.com/yuque/0/2022/png/26758626/1650210813030-8d378904-7213-461f-93dd-2c24c6ba0c0d.png##clientId=u8a2ba187-a65d-4&crop=0&crop=0&crop=1&crop=1&from=paste&id=u0251cbb3&margin=%5Bobject%20Object%5D&originHeight=345&originWidth=1184&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=uc0e122d1-7f93-45b4-9523-11a3e6c6615&title="></p>
<hr>
<p><strong>重写规则说明</strong></p>
<p>aof 默认就是文件的无限追加，文件会越来越大！<br><img src="https://cdn.nlark.com/yuque/0/2022/png/26758626/1650210846808-0286e3e4-d46d-4ede-80a4-322844459466.png##clientId=u8a2ba187-a65d-4&crop=0&crop=0&crop=1&crop=1&from=paste&id=uda9ab224&margin=%5Bobject%20Object%5D&originHeight=665&originWidth=1110&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u59783648-68d5-40b9-a960-839e96070f4&title="><br>如果 aof 文件大于 64m，太大了！ fork一个新的进程来将我们的文件进行重写！</p>
<hr>
<p><strong>AOF优点</strong>：</p>
<ul>
<li>每次修改都同步，文件的完成性会更好</li>
<li>每秒同步一次，<strong>可能会丢失最后一秒数据</strong></li>
<li>从不同步，效率最高</li>
</ul>
<p><strong>AOF缺点：</strong></p>
<ul>
<li>相对于rdb，aof远大于rdb，修复速度也比rdb慢</li>
<li>aof运行效率也比rdb慢，因此默认rdb</li>
</ul>
<p>扩展：<br>1、RDB 持久化方式能够在指定的时间间隔内对你的数据进行快照存储<br>2、AOF 持久化方式记录每次对服务器写的操作，当服务器重启的时候会重新执行这些命令来恢复原始的数据，AOF命令以Redis 协议追加保存每次写的操作到文件末尾，Redis还能对AOF文件进行后台重写，使得AOF文件的体积不至于过大。<br>3、只做缓存，如果你只希望你的数据在服务器运行的时候存在，你也可以不使用任何持久化<br>4、同时开启两种持久化方式<br>在这种情况下，当redis重启的时候会优先载入AOF文件来恢复原始的数据，因为在通常情况下AOF文件保存的数据集要比RDB文件保存的数据集要完整。RDB 的数据不实时，同时使用两者时服务器重启也只会找AOF文件，那要不要只使用AOF呢？作者建议不要，因为RDB更适合用于备份数据库（AOF在不断变化不好备份），快速重启，而且不会有AOF可能潜在的Bug，留着作为一个万一的手段。<br>5、性能建议<br>因为RDB文件只用作后备用途，建议只在Slave上持久化RDB文件，而且只要15分钟备份一次就够了，只保留 save 900 1 这条规则。如果Enable AOF ，好处是在最恶劣情况下也只会丢失不超过两秒数据，启动脚本较简单只load自己的AOF文件就可以了，代价一是带来了持续的IO，二是AOF rewrite 的最后将 rewrite 过程中产生的新数据写到新文件造成的阻塞几乎是不可避免的。只要硬盘许可，应该尽量减少AOF rewrite的频率，AOF重写的基础大小默认值64M太小了，可以设到5G以上，默认超过原大小100%大小重写可以改到适当的数值。如果不Enable AOF ，仅靠 Master-Slave Repllcation 实现高可用性也可以，能省掉一大笔IO，也减少了rewrite时带来的系统波动。代价是如果Master&#x2F;Slave 同时倒掉，会丢失十几分钟的数据，启动脚本也要比较两个 Master&#x2F;Slave 中的 RDB文件，载入较新的那个，微博就是这种架构。</p>
<h2 id="10-订阅发布"><a href="#10-订阅发布" class="headerlink" title="10. 订阅发布"></a>10. 订阅发布</h2><p>Redis 发布订阅(pub&#x2F;sub)是一种消息通信模式：发送者(pub)发送消息，订阅者(sub)接收消息。微信、微博、关注系统！<br>Redis 客户端可以订阅任意数量的频道。</p>
<p>订阅&#x2F;发布消息图：<br>第一个：消息发送者， 第二个：频道 第三个：消息订阅者！<a target="_blank" rel="noopener" href="https://blog.51cto.com/zhangzhixi/3175577">
</a><img src="https://cdn.nlark.com/yuque/0/2022/png/26758626/1650285249827-42117319-aa8e-481c-978a-4330a27026f5.png##clientId=ue836c7aa-ce6f-4&crop=0&crop=0&crop=1&crop=1&from=paste&id=u8ea750d8&margin=%5Bobject%20Object%5D&originHeight=451&originWidth=1088&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u79c7a054-4705-4ff8-a8a7-e9600ff51ff&title="></p>
<p>下图展示了频道 channel1 ， 以及订阅这个频道的三个客户端 —— client2 、 client5 和 client1 之间的关系：</p>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/26758626/1650285282271-8a14c418-37eb-4053-96b1-3670c730e8aa.png##clientId=ue836c7aa-ce6f-4&crop=0&crop=0&crop=1&crop=1&from=paste&id=u4fa7b9b7&margin=%5Bobject%20Object%5D&originHeight=358&originWidth=591&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=ue61e377f-69e0-4b87-8db6-28e400009f1&title="></p>
<p> 当有新消息通过 PUBLISH 命令发送给频道 channel1 时， 这个消息就会被发送给订阅它的三个客户端：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/26758626/1650285297639-b3e7d68f-3b8b-4adf-92a6-2635b6ad31dc.png##clientId=ue836c7aa-ce6f-4&crop=0&crop=0&crop=1&crop=1&from=paste&id=ue57afe77&margin=%5Bobject%20Object%5D&originHeight=518&originWidth=584&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=ue13445e1-071c-4f5d-8e53-b1136af6573&title="></p>
<hr>
<p><strong>命令</strong><br><img src="https://cdn.nlark.com/yuque/0/2022/png/26758626/1650285325585-999f5581-ff58-4d55-aa21-d974734a0de3.png##clientId=ue836c7aa-ce6f-4&crop=0&crop=0&crop=1&crop=1&from=paste&id=u61d0163e&margin=%5Bobject%20Object%5D&originHeight=632&originWidth=578&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=ud1c69843-079f-45cd-b781-08d1e841a38&title="></p>
<h2 id="11-主从复制"><a href="#11-主从复制" class="headerlink" title="11. 主从复制"></a>11. 主从复制</h2><p>主从复制，是指将一台Redis服务器的数据，复制到其他的Redis服务器。前者称为主节点(master&#x2F;leader)，后者称为从节点(slave&#x2F;follower)；数据的复制是单向的，只能由主节点到从节点。<br>Master以写为主，Slave 以读为主。<br>　　<strong>默认情况下，每台Redis服务器都是主节点；</strong><br>且一个主节点可以有多个从节点(或没有从节点)，但一个从节点只能有一个主节点。</p>
<p><strong>主从复制的作用主要包括：</strong><br>1、数据冗余：主从复制实现了数据的热备份，是持久化之外的一种数据冗余方式。<br>2、故障恢复：当主节点出现问题时，可以由从节点提供服务，实现快速的故障恢复；实际上是一种服务的冗余。<br>3、负载均衡：在主从复制的基础上，配合读写分离，可以由主节点提供写服务，由从节点提供读服务（即写Redis数据时应用连接主节点，读Redis数据时应用连接从节点），分担服务器负载；尤其是在写少读多的场景下，通过多个从节点分担读负载，可以大大提高Redis服务器的并发量。<br>4、高可用（集群）基石：除了上述作用以外，主从复制还是哨兵和集群能够实施的基础，因此说主从复制是Redis高可用的基础。<br>一般来说，要将Redis运用于工程项目中，只使用一台Redis是万万不能的（宕机），原因如下：<br>1、从结构上，单个Redis服务器会发生单点故障，并且一台服务器需要处理所有的请求负载，压力较大；<br>2、从容量上，单个Redis服务器内存容量有限，就算一台Redis服务器内存容量为256G，也不能将所有内存用作Redis存储内存，一般来说，单台Redis最大使用内存不应该超过20G。<br>电商网站上的商品，一般都是一次上传，无数次浏览的，说专业点也就是”多读少写”。</p>
<p>对于这种场景，我们可以使如下这种架构：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/26758626/1650286930592-6c5af5e6-2a3d-419a-ba2e-3a4cb15335ab.png##clientId=ue836c7aa-ce6f-4&crop=0&crop=0&crop=1&crop=1&from=paste&id=u223a61ea&margin=%5Bobject%20Object%5D&originHeight=724&originWidth=1099&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=ued1825c9-1ce9-44e7-8f49-1ad8325ae57&title="><br>主从复制，读写分离！ 80% 的情况下都是在进行读操作！减缓服务器的压力！架构中经常使用！ 一主二从！</p>
<h4 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h4><p><strong>只配置从库，不用配置主库！</strong><br><img src="https://cdn.nlark.com/yuque/0/2022/png/26758626/1650287001813-3cd41d83-3f0a-4ed0-a13f-4f858e3b0a9b.png##clientId=ue836c7aa-ce6f-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=698&id=u8695758a&margin=%5Bobject%20Object%5D&name=image.png&originHeight=698&originWidth=1220&originalType=binary&ratio=1&rotation=0&showTitle=false&size=122007&status=done&style=none&taskId=u3118214a-9007-41cd-ab04-931d854eb17&title=&width=1220" alt="image.png"></p>
<h4 id="一主二从"><a href="#一主二从" class="headerlink" title="一主二从"></a>一主二从</h4><p><strong>默认情况下，每台redis服务器都是主节点！！</strong></p>
<p>认老大！ 一主 （79）二从（80，81）<br><img src="https://cdn.nlark.com/yuque/0/2022/png/26758626/1650287086432-e858ec80-a0ed-4224-b49e-9471bcc581cc.png##clientId=ue836c7aa-ce6f-4&crop=0&crop=0&crop=1&crop=1&from=paste&id=ubb8d6bbf&margin=%5Bobject%20Object%5D&originHeight=460&originWidth=817&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=ud5bd7a52-cdd3-421e-a145-92098c42059&title="><br><img src="https://cdn.nlark.com/yuque/0/2022/png/26758626/1650287103949-ef5df0ff-a685-4af4-8bc7-c5742545a14c.png##clientId=ue836c7aa-ce6f-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=749&id=u1a64211d&margin=%5Bobject%20Object%5D&name=image.png&originHeight=749&originWidth=1092&originalType=binary&ratio=1&rotation=0&showTitle=false&size=80399&status=done&style=none&taskId=u5b69e22c-c48f-4e7b-a414-08cdf6effaf&title=&width=1092" alt="image.png"></p>
<hr>
<p><strong>注意</strong><br>主机可以写，从机不能写只能读！主机中的所有信息和数据，都会自动被从机保存！<br>主机写：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/26758626/1650287146573-e3fa37f9-7396-48ef-8646-4cfa19151e38.png##clientId=ue836c7aa-ce6f-4&crop=0&crop=0&crop=1&crop=1&from=paste&id=u516ae957&margin=%5Bobject%20Object%5D&originHeight=116&originWidth=628&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=ud4add2bc-61e5-4d96-a3b0-ce8adba7084&title="><br>从机只能读取，不能写入：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/26758626/1650287161547-625d9c89-1713-40ce-94d8-90a21437b1eb.png##clientId=ue836c7aa-ce6f-4&crop=0&crop=0&crop=1&crop=1&from=paste&id=uc02ee335&margin=%5Bobject%20Object%5D&originHeight=176&originWidth=661&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=uead97089-5cf5-4232-9850-d5946f3fd66&title="><br>测试：主机断开连接，<strong>从机依旧连接到主机的，但是没有写操作</strong>，这个时候，主机如果回来了，从机依旧可以直接获取到主机写的信息！</p>
<p>如果是使用命令行，来配置的主从，这个时候如果重启了，从机就会变回主机，与之前的主机断开连接！<br><strong>只要再变为从机，立马就会从主机中获取值！</strong></p>
<h2 id="12-哨兵模式"><a href="#12-哨兵模式" class="headerlink" title="12. 哨兵模式"></a>12. 哨兵模式</h2><p>　主从切换技术的方法是：当主服务器宕机后，需要手动把一台从服务器切换为主服务器，这就需要人工干预，费事费力，还会造成一段时间内服务不可用。这不是一种推荐的方式，更多时候，我们优先考虑哨兵模式。</p>
<p>Redis从2.8开始正式提供了Sentinel（哨兵） 架构来解决这个问题。<br>谋朝篡位的自动版，能够后台监控主机是否故障，如果故障了根据投票数自动将从库转换为主库。</p>
<p>哨兵模式是一种特殊的模式，首先Redis提供了哨兵的命令，哨兵是一个独立的进程，作为进程，它会独立运行。其原理是哨兵通过发送命令，等待Redis服务器响应，从而监控运行的多个Redis实例。<br>这里的哨兵有两个作用</p>
<p>通过发送命令，让Redis服务器返回监控其运行状态，包括主服务器和从服务器。<br>当哨兵监测到master宕机，会自动将slave切换成master，然后通过发布订阅模式通知其他的从服务器，修改配置文件，让它们切换主机。<br>然而一个哨兵进程对Redis服务器进行监控，可能会出现问题，为此，我们可以使用多个哨兵进行监控。各个哨兵之间还会进行监控，这样就形成了多哨兵模式。<br><img src="https://cdn.nlark.com/yuque/0/2022/png/26758626/1650289429010-e306c700-439f-404f-9be2-c6229d6ede0d.png##clientId=ue836c7aa-ce6f-4&crop=0&crop=0&crop=1&crop=1&from=paste&id=u89d7d337&margin=%5Bobject%20Object%5D&originHeight=560&originWidth=1051&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u498ec645-7144-4d33-916c-5cb850ba760&title="></p>
<p>假设主服务器宕机，哨兵1先检测到这个结果，系统并不会马上进行failover过程，仅仅是哨兵1主观的认为主服务器不可用，这个现象成为<strong>主观下线</strong>。当后面的哨兵也检测到主服务器不可用，并且数量达到一定值时，那么哨兵之间就会进行一次投票，投票的结果由一个哨兵发起，进行failover[故障转移]操作。<br>切换成功后，就会通过发布订阅模式，让各个哨兵把自己监控的从服务器实现切换主机，这个过程称为<strong>客观下线。</strong></p>
<p>我们目前的状态是 一主二从！<br><strong>配置步骤：</strong><br>1、配置哨兵配置文件 sentinel.conf</p>
<pre class="line-numbers language-none"><code class="language-none">sentinel monitor 哨兵名称 local post 1(表示有几个哨兵通过就让它称为老大)
sentinel monitor myredis 182.92.209.212 6379 1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>2.启动哨兵<br><img src="https://cdn.nlark.com/yuque/0/2022/png/26758626/1650289522530-e51e399e-5f5c-4c75-b98e-a61b20c8ca9a.png##clientId=ue836c7aa-ce6f-4&crop=0&crop=0&crop=1&crop=1&from=paste&id=u69c24dbb&margin=%5Bobject%20Object%5D&originHeight=666&originWidth=1108&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=ud0f67cce-04b5-4671-88e6-3321641cf4d&title="></p>
<p>如果Master 节点断开了，这个时候就会从从机中随机选择一个服务器！ （这里面有一个投票算法！）<br>如果主机此时回来了，<strong>只能归并到新的主机下，当做从机</strong>，这就是哨兵模式的规则！</p>
<p><strong>哨兵模式优缺点</strong><br><strong>优点：</strong><br>1、哨兵集群，基于主从复制模式，所有的主从配置优点，它全有<br>2、 主从可以切换，故障可以转移，系统的<strong>可用性</strong>就会更好<br>3、哨兵模式就是主从模式的升级，<strong>手动到自动</strong>，更加健壮！<br><strong>缺点：</strong><br>1、Redis <strong>不好在线扩容</strong>的，集群容量一旦到达上限，在线扩容就十分麻烦！<br>2、实现哨兵模式的<strong>配置其实是很麻烦</strong>的，里面有很多选择！</p>
<h2 id="13-缓存穿透和缓存雪崩"><a href="#13-缓存穿透和缓存雪崩" class="headerlink" title="13. 缓存穿透和缓存雪崩"></a>13. 缓存穿透和缓存雪崩</h2><p><strong>服务的高可用问题</strong></p>
<p>Redis缓存的使用，极大的提升了应用程序的性能和效率，特别是数据查询方面。但同时，它也带来了一些问题。其中，最要害的问题，就是数据的一致性问题，从严格意义上讲，这个问题无解。如果对数据的一致性要求很高，那么就不能使用缓存。</p>
<p>另外的一些典型问题就是，缓存穿透、缓存雪崩和缓存击穿。目前，业界也都有比较流行的解决方案。<br><img src="https://cdn.nlark.com/yuque/0/2022/png/26758626/1650289796937-5d2e880b-a99e-40b3-8c45-cad92a2829d0.png##clientId=ue836c7aa-ce6f-4&crop=0&crop=0&crop=1&crop=1&from=paste&id=u5d7c0a33&margin=%5Bobject%20Object%5D&originHeight=473&originWidth=1033&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=ua4258262-59a4-43c7-8ac8-1253a25397b&title="></p>
<h4 id="缓存穿透（查不到数据）"><a href="#缓存穿透（查不到数据）" class="headerlink" title="缓存穿透（查不到数据）"></a>缓存穿透（查不到数据）</h4><p>缓存穿透的概念很简单，用户想要查询一个数据，发现redis内存数据库没有，也就是缓存没有命中，于是向持久层数据库查询。发现也没有，于是本次查询失败。当用户很多的时候，缓存都没有命中（秒杀！），于是都去请求了持久层数据库。这会给持久层数据库造成很大的压力，这时候就相当于出现了缓存穿透。</p>
<p>解决方案 ：布隆过滤器 和 缓存空对象<br>布隆过滤器是一种数据结构，对所有可能查询的参数<strong>以hash形式</strong>存储，在<strong>控制层先进行校验</strong>，不符合则丢弃，从而避免了对底层存储系统的查询压力。<br><img src="https://cdn.nlark.com/yuque/0/2022/png/26758626/1650289943140-43e5375b-c1b0-46f0-9f06-5fdc8851c6cc.png##clientId=ue836c7aa-ce6f-4&crop=0&crop=0&crop=1&crop=1&from=paste&id=u5ae3c53e&margin=%5Bobject%20Object%5D&originHeight=653&originWidth=655&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u2cac1ec1-f8f9-40c0-9551-31bf378f6cf&title="></p>
<p>缓存空对象<br>当存储层不命中后，即使返回的空对象也将其缓存起来，同时会设置一个过期时间，之后再访问这个数据将会从缓存中获取，保护了后端数据源。<br><img src="https://cdn.nlark.com/yuque/0/2022/png/26758626/1650290256789-afaa0834-5eea-429d-8f9e-0cba2e4ccbfd.png##clientId=ue836c7aa-ce6f-4&crop=0&crop=0&crop=1&crop=1&from=paste&id=u5faf905a&margin=%5Bobject%20Object%5D&originHeight=657&originWidth=578&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=uf53ff829-2c96-4593-adcc-49fabfe5f9d&title="><br>但是这种方法会存在两个问题：</p>
<ul>
<li>1、如果空值能够被缓存起来，这就意味着缓存需要更多的空间存储更多的键，因为这当中可能会有很多的空值的键；</li>
<li>2、即使对空值设置了过期时间，还是会存在缓存层和存储层的数据会有一段<strong>时间窗口的不一致</strong>，这对于需要<strong>保持一致性</strong>的业务会有影响。</li>
</ul>
<h4 id="缓存击穿（量太大，缓存过期）"><a href="#缓存击穿（量太大，缓存过期）" class="headerlink" title="缓存击穿（量太大，缓存过期）"></a>缓存击穿（量太大，缓存过期）</h4><p>这里需要注意和缓存击穿的区别，缓存击穿，是指一个key非常热点，在不停的扛着大并发，大并发集中对这一个点进行访问，当这个key在失效的瞬间，<strong>持续的大并发就穿破缓存</strong>，直接请求数据库，就像在一个屏障上凿开了一个洞。<br>当某个key在过期的瞬间，有大量的请求并发访问，<strong>这类数据一般是热点数据</strong>，由于缓存过期，会同时访问数据库来查询最新数据，并且回写缓存，会导使数据库瞬间压力过大。</p>
<p>解决方案： </p>
<ul>
<li>设置热点数据不过期<ul>
<li>从缓存层面来看，没有设置过期时间，所以不会出现热点 key 过期后产生的问题。</li>
</ul>
</li>
<li>加互斥锁<ul>
<li>使用分布式锁，保证对于每个key同时只有一个线程去查询后端服务，其他线程没有获得分布式锁的权限，因此只需要等待即可。这种方式将高并发的压力转移到了分布式锁，因此对分布式锁的考验很大。</li>
</ul>
</li>
</ul>
<h4 id="缓存雪崩"><a href="#缓存雪崩" class="headerlink" title="缓存雪崩"></a>缓存雪崩</h4><p>缓存雪崩，是指在某一个时间段，<strong>缓存集中过期失效</strong>。Redis 宕机！<br>产生雪崩的原因之一，比如在写本文的时候，马上就要到双十二零点，很快就会迎来一波抢购，这波商品时间比较集中的放入了缓存，假设缓存一个小时。那么到了凌晨一点钟的时候，这批商品的缓存就都过期了。而对这批商品的访问查询，都落到了数据库上，对于数据库而言，<strong>就会产生周期性的压力波</strong>峰。于是所有的请求都会达到存储层，<strong>存储层的调用量会暴增</strong>，造成存储层也会挂掉的情况。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/26758626/1650290628209-57409a28-b0f4-48ae-b19c-410998731809.png##clientId=ue836c7aa-ce6f-4&crop=0&crop=0&crop=1&crop=1&from=paste&id=u8677da01&margin=%5Bobject%20Object%5D&originHeight=640&originWidth=1109&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=uaf5e9a9e-66dd-46af-8586-8d8a3f6c92c&title="></p>
<p>其实集中过期，倒不是非常致命，比较致命的缓存雪崩，是<strong>缓存服务器某个节点宕机或断网</strong>。因为自然形成的缓存雪崩，一定是在某个时间段集中创建缓存，这个时候，数据库也是可以顶住压力的。无非就是对数据库产生周期性的压力而已。而缓存服务节点的宕机，对数据库服务器造成的压力是不可预知的，很有可能瞬间就把数据库压垮。</p>
<p>解决方案：</p>
<ul>
<li>redis高可用</li>
</ul>
<p>这个思想的含义是，既然redis有可能挂掉，那我多增设几台redis，这样一台挂掉之后其他的还可以继续工作，其实就是搭建的集群。（异地多活！）</p>
<ul>
<li>限流降级（在SpringCloud讲解过！）</li>
</ul>
<p>这个解决方案的思想是，在缓存失效后，通过加锁或者队列来控制读数据库写缓存的线程数量。比如对某个key只允许一个线程查询数据和写缓存，其他线程等待。</p>
<ul>
<li>数据预热</li>
</ul>
<p>数据加热的含义就是在正式部署之前，我先把可能的数据先预先访问一遍，这样部分可能大量访问的数据就会加载到缓存中。在即将发生大并发访问前手动触发加载缓存不同的key，设置不同的过期时间，让<br>缓存失效的时间点尽量均匀。<br><a target="_blank" rel="noopener" href="https://blog.51cto.com/zhangzhixi/3175577">
</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.51cto.com/zhangzhixi/3175577">
</a></p>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">沈嘉伟</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://910650692.github.io/2022/04/18/Redis%E5%AD%A6%E4%B9%A0/">https://910650692.github.io/2022/04/18/Redis%E5%AD%A6%E4%B9%A0/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">沈嘉伟</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/Redis/">
                                    <span class="chip bg-color">Redis</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2022/04/20/%E7%89%9B%E5%AE%A2%E8%AE%BA%E5%9D%9B%E9%A1%B9%E7%9B%AE%20%E5%AE%9E%E7%8E%B0%E6%A8%A1%E5%9D%97%EF%BC%88%E4%B8%8A%EF%BC%89/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/4.jpg" class="responsive-img" alt="牛客论坛项目 实现模块(上)">
                        
                        <span class="card-title">牛客论坛项目 实现模块(上)</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            牛客论坛功能模块
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2022-04-20
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E9%A1%B9%E7%9B%AE/" class="post-category">
                                    项目
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Springboot/">
                        <span class="chip bg-color">Springboot</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2022/04/13/Mysql%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/17.jpg" class="responsive-img" alt="Mysql基础知识">
                        
                        <span class="card-title">Mysql基础知识</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            MySQL基础
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2022-04-13
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/MySQL/" class="post-category">
                                    MySQL
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/MySQL/">
                        <span class="chip bg-color">MySQL</span>
                    </a>
                    
                    <a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/">
                        <span class="chip bg-color">数据库</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>


<script src="https://cdn.bootcss.com/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script>
    MathJax.Hub.Config({
        tex2jax: {inlineMath: [['$', '$'], ['\\(', '\\)']]}
    });
</script>



    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="503838841"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="/libs/aplayer/Meting.min.js"></script>

    

    <div class="container row center-align"
         style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2022</span>
            
            <a href="/about" target="_blank">沈嘉伟</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
                &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                        class="white-color">27.4k</span>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/910650692" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:910650692@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=910650692" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 910650692" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    

    

    <!-- 雪花特效 -->
    

    <!-- 鼠标星星特效 -->
    

     
        <script src="https://ssl.captcha.qq.com/TCaptcha.js"></script>
        <script src="/libs/others/TencentCaptcha.js"></script>
        <button id="TencentCaptcha" data-appid="xxxxxxxxxx" data-cbfn="callback" type="button" hidden></button>
    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
